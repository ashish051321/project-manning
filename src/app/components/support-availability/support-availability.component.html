<div class="support-availability-container">
  <div class="header">
    <h1>Support Availability Calendar</h1>
    <p>Monitor application support risks based on developer vacations</p>
  </div>

  <!-- Selection Controls -->
  <div class="selection-controls">
    <div class="control-group">
      <label for="teamSelect">Team</label>
      <select 
        id="teamSelect" 
        [(ngModel)]="selectedTeamId" 
        (change)="onTeamChange()"
        class="form-select">
        <option value="">Select Team</option>
        <option *ngFor="let team of teams" [value]="team.id">
          {{ team.name }}
        </option>
      </select>
    </div>

    <div class="control-group">
      <label for="appSelect">Application</label>
      <select 
        id="appSelect" 
        [(ngModel)]="selectedApplication" 
        (change)="onApplicationChange()"
        class="form-select">
        <option value="">Select Application</option>
        <option value="all">All Apps</option>
        <option *ngFor="let app of applications" [value]="app">
          {{ app }}
        </option>
      </select>
    </div>
  </div>

  <!-- Calendar Navigation -->
  <div class="calendar-header" *ngIf="selectedTeamId && selectedApplication">
    <div class="calendar-nav">
      <button class="nav-btn" (click)="previousMonth()">
        <span class="nav-icon">‚Äπ</span>
      </button>
      <h2 class="month-title">{{ getMonthName() }}</h2>
      <button class="nav-btn" (click)="nextMonth()">
        <span class="nav-icon">‚Ä∫</span>
      </button>
    </div>
    <button class="today-btn" (click)="goToToday()">Today</button>
  </div>

  <!-- Risk Legend -->
  <div class="risk-legend" *ngIf="selectedTeamId && selectedApplication">
    <div class="legend-item">
      <div class="legend-color risk"></div>
      <span *ngIf="selectedApplication === 'all'">
        No Support Available - All developers for one or more applications are on vacation
      </span>
      <span *ngIf="selectedApplication !== 'all'">
        No Support Available - All developers with this application skill are on vacation
      </span>
    </div>
  </div>

  <!-- Calendar -->
  <div class="calendar-container" *ngIf="selectedTeamId && selectedApplication && !loading">
    <!-- Day Headers -->
    <div class="calendar-grid">
      <div class="day-header" *ngFor="let dayName of [0,1,2,3,4,5,6]">
        {{ getDayName(dayName) }}
      </div>

      <!-- Calendar Days -->
      <div 
        class="calendar-day" 
        *ngFor="let day of calendarDays; let i = index"
        [class.other-month]="!day.isCurrentMonth"
        [class.today]="day.isToday"
        [class.at-risk]="day.isAtRisk"
        [class.clickable]="day.isAtRisk && day.unavailableDevelopers.length > 0"
        (click)="onDateClick(day)"
        [title]="getTooltipText(day)">
        
        <div class="day-number">{{ day.date.getDate() }}</div>
        
        <!-- Risk Indicator -->
        <div class="risk-indicator" *ngIf="day.isAtRisk">
          <span class="risk-icon">‚ö†Ô∏è</span>
          <div class="developer-count" *ngIf="day.unavailableDevelopers.length > 1">
            {{ day.unavailableDevelopers.length }}
          </div>
          <div class="app-count" *ngIf="selectedApplication === 'all' && day.affectedApps.length > 1">
            {{ day.affectedApps.length }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading support availability data...</p>
  </div>

  <!-- No Selection State -->
  <div class="no-selection-state" *ngIf="!loading && (!selectedTeamId || !selectedApplication)">
    <div class="no-selection-icon">üìÖ</div>
    <h3>Select Team and Application</h3>
    <p>Choose a team and application to view support availability calendar</p>
  </div>

  <!-- No Risk State -->
  <div class="no-risk-state" *ngIf="!loading && selectedTeamId && selectedApplication && calendarDays.length > 0 && !hasAnyRiskDays()">
    <div class="no-risk-icon">‚úÖ</div>
    <h3>No Support Risks Detected</h3>
    <p *ngIf="selectedApplication === 'all'">
      All developers for all team applications are available for the selected period
    </p>
    <p *ngIf="selectedApplication !== 'all'">
      All developers with {{ selectedApplication }} skills are available for the selected period
    </p>
  </div>

  <!-- Risk Details Popup Modal -->
  <div class="popup-overlay" *ngIf="showPopup" (click)="closePopup()">
    <div class="popup-modal" (click)="$event.stopPropagation()">
      <div class="popup-header">
        <h3>{{ getPopupTitle() }}</h3>
        <button class="popup-close" (click)="closePopup()">√ó</button>
      </div>
      
      <div class="popup-content">
        <div class="risk-summary">
          <div class="risk-icon">‚ö†Ô∏è</div>
          <div class="risk-message">
            <h4>Support Risk Detected</h4>
            <p>One or more applications have no available support due to team members being on leave.</p>
          </div>
        </div>

        <div class="risk-details">
          <!-- Application-specific risk sections -->
          <div class="application-risk-section" *ngFor="let appRisk of getRiskDataByApplication()">
            <div class="app-header" [class.at-risk]="appRisk.isAtRisk">
              <h5>
                <span class="app-icon">üö´</span>
                {{ appRisk.application }}
                <span class="risk-status" *ngIf="appRisk.isAtRisk">- AT RISK</span>
                <span class="safe-status" *ngIf="!appRisk.isAtRisk">- SAFE</span>
              </h5>
              <div class="app-stats">
                <span class="stat-badge">
                  {{ appRisk.unavailableDevelopers.length }}/{{ appRisk.totalDevelopers }} unavailable
                </span>
              </div>
            </div>

            <div class="app-developers" *ngIf="appRisk.unavailableDevelopers.length > 0">
              <h6>üë• Team Members on Leave for this Application:</h6>
              <div class="developers-list">
                <div class="developer-item" *ngFor="let developer of appRisk.unavailableDevelopers">
                  <div class="developer-info">
                    <span class="developer-name clickable" (click)="navigateToDeveloper(developer.id)">
                      {{ developer.name }}
                    </span>
                    <span class="developer-details">{{ getDeveloperDetails(developer) }}</span>
                  </div>
                  <div class="resource-type" *ngIf="developer.isSharedResource">
                    <span class="sr-badge">SR</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="app-status" *ngIf="appRisk.unavailableDevelopers.length === 0">
              <p class="safe-message">‚úÖ All developers for this application are available</p>
            </div>
          </div>

          <!-- Overall Impact Summary -->
          <div class="detail-section">
            <h5>üìä Overall Impact Summary</h5>
            <div class="impact-summary">
              <div class="impact-item">
                <span class="impact-label">Applications at Risk:</span>
                <span class="impact-value">{{ selectedDay?.affectedApps?.length || 0 }}</span>
              </div>
              <div class="impact-item">
                <span class="impact-label">Total Team Members Unavailable:</span>
                <span class="impact-value">{{ selectedDay?.unavailableDevelopers?.length || 0 }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="popup-actions">
        <button class="btn-secondary" (click)="closePopup()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Team Applications Table -->
  <div class="team-applications-section" *ngIf="selectedTeamId && !loading">
    <div class="section-header">
      <h2>Team Applications & Responsibilities</h2>
      <p>Applications owned by {{ getTeamName(selectedTeamId) }} and team members responsible for each</p>
    </div>

    <div class="applications-table-container" *ngIf="hasTeamApplications()">
      <table class="applications-table">
        <thead>
          <tr>
            <th>Application</th>
            <th>Team Members</th>
            <th>Total Members</th>
            <th>Skill Distribution</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let appData of getTeamApplicationsWithDevelopers()">
            <td class="app-name">
              <div class="app-info">
                <span class="app-title">{{ appData.application }}</span>
              </div>
            </td>
            <td class="developers-list">
              <div class="developer-items">
                <div 
                  class="developer-item" 
                  *ngFor="let developer of appData.developers"
                  [class.shared-resource]="developer.isSharedResource">
                  <span class="developer-name clickable" (click)="navigateToDeveloper(developer.id)">
                    {{ developer.name }}
                  </span>
                  <span class="skill-level" [class]="getSkillLevelClass(getDeveloperSkillLevel(developer, appData.application))">
                    {{ getDeveloperSkillLevel(developer, appData.application) }}/10
                  </span>
                  <span class="resource-type" *ngIf="developer.isSharedResource">SR</span>
                </div>
              </div>
            </td>
            <td class="total-count">
              <span class="count-badge">{{ appData.totalDevelopers }}</span>
            </td>
            <td class="skill-distribution">
              <div class="skill-bars">
                <div class="skill-bar expert" 
                     [style.width.%]="getSkillDistribution(appData.developers, appData.application, 'expert')"
                     [title]="getSkillDistributionTooltip(appData.developers, appData.application, 'expert')">
                  <span class="skill-label">Expert</span>
                </div>
                <div class="skill-bar advanced" 
                     [style.width.%]="getSkillDistribution(appData.developers, appData.application, 'advanced')"
                     [title]="getSkillDistributionTooltip(appData.developers, appData.application, 'advanced')">
                  <span class="skill-label">Advanced</span>
                </div>
                <div class="skill-bar intermediate" 
                     [style.width.%]="getSkillDistribution(appData.developers, appData.application, 'intermediate')"
                     [title]="getSkillDistributionTooltip(appData.developers, appData.application, 'intermediate')">
                  <span class="skill-label">Intermediate</span>
                </div>
                <div class="skill-bar beginner" 
                     [style.width.%]="getSkillDistribution(appData.developers, appData.application, 'beginner')"
                     [title]="getSkillDistributionTooltip(appData.developers, appData.application, 'beginner')">
                  <span class="skill-label">Beginner</span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="no-applications-state" *ngIf="!hasTeamApplications()">
      <div class="no-applications-icon">üì±</div>
      <h3>No Applications Found</h3>
      <p>This team doesn't have any developers with application skills assigned</p>
    </div>
  </div>

  <!-- Unassigned Team Members Table -->
  <div class="unassigned-members-section" *ngIf="selectedTeamId && !loading">
    <div class="section-header">
      <h2>Unassigned Team Members</h2>
      <p>Team members not currently assigned to any team applications</p>
    </div>

    <div class="unassigned-table-container" *ngIf="hasUnassignedTeamMembers()">
      <table class="unassigned-table">
        <thead>
          <tr>
            <th>Team Member</th>
            <th>Resource Type</th>
            <th>Tech Skills</th>
            <th>Other App Skills</th>
            <th>Highest Tech Level</th>
            <th>Highest App Level</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let developer of getUnassignedTeamMembers()">
            <td class="developer-name-cell">
              <span class="developer-name clickable" (click)="navigateToDeveloper(developer.id)">
                {{ developer.name }}
              </span>
            </td>
            <td class="resource-type-cell">
              <span class="resource-badge" [class]="developer.isSharedResource ? 'shared' : 'primary'">
                {{ developer.isSharedResource ? 'Shared Resource' : 'Primary Member' }}
              </span>
            </td>
            <td class="tech-skills-cell">
              <div class="skills-list" *ngIf="getDeveloperTechSkills(developer).length > 0">
                <span 
                  class="skill-tag" 
                  *ngFor="let skill of getDeveloperTechSkills(developer)"
                  [title]="skill + ': ' + developer.techSkills[skill] + '/10'">
                  {{ skill }} ({{ developer.techSkills[skill] }}/10)
                </span>
              </div>
              <span class="no-skills" *ngIf="getDeveloperTechSkills(developer).length === 0">No tech skills</span>
            </td>
            <td class="app-skills-cell">
              <div class="skills-list" *ngIf="getDeveloperAppSkills(developer).length > 0">
                <span 
                  class="skill-tag other-app" 
                  *ngFor="let app of getDeveloperAppSkills(developer)"
                  [title]="app + ': ' + developer.appSkills[app] + '/10'">
                  {{ app }} ({{ developer.appSkills[app] }}/10)
                </span>
              </div>
              <span class="no-skills" *ngIf="getDeveloperAppSkills(developer).length === 0">No app skills</span>
            </td>
            <td class="highest-tech-cell">
              <span class="level-badge" [class]="getSkillLevelClass(getHighestTechSkillLevel(developer))" *ngIf="getHighestTechSkillLevel(developer) > 0">
                {{ getHighestTechSkillLevel(developer) }}/10
              </span>
              <span class="no-level" *ngIf="getHighestTechSkillLevel(developer) === 0">-</span>
            </td>
            <td class="highest-app-cell">
              <span class="level-badge" [class]="getSkillLevelClass(getHighestAppSkillLevel(developer))" *ngIf="getHighestAppSkillLevel(developer) > 0">
                {{ getHighestAppSkillLevel(developer) }}/10
              </span>
              <span class="no-level" *ngIf="getHighestAppSkillLevel(developer) === 0">-</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="no-unassigned-state" *ngIf="!hasUnassignedTeamMembers()">
      <div class="no-unassigned-icon">‚úÖ</div>
      <h3>All Team Members Assigned</h3>
      <p>All team members are currently assigned to team applications</p>
    </div>
  </div>
</div> 